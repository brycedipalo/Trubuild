---
// Gallery section with Keen-slider
// Images processed through Astro's image pipeline for WebP conversion + compression
import { Image } from 'astro:assets';
import type { ImageMetadata } from 'astro';

const imageModules = import.meta.glob<{ default: ImageMetadata }>(
	'/src/assets/gallery/*.jpg',
	{ eager: true }
);

// Sort by numeric filename (1.jpg, 2.jpg, etc.)
const images = Object.entries(imageModules)
	.map(([path, mod]) => ({
		num: parseInt(path.match(/(\d+)\.jpg$/)?.[1] || '0'),
		image: mod.default
	}))
	.sort((a, b) => a.num - b.num)
	.map(entry => entry.image);
---

<section id="gallery" class="py-16 bg-gray-100">
	<div class="container mx-auto px-4">
		<h2 class="text-3xl font-semibold text-center mb-12">See the Difference</h2>

		<!-- Keen Slider Container -->
		<div class="relative max-w-4xl mx-auto">
			<div class="keen-slider rounded-lg shadow-xl overflow-hidden">
				{images.map((img, idx) => (
					<div class="keen-slider__slide">
						<Image
							src={img}
							alt={`Project photo ${idx + 1}`}
							widths={[640, 1024]}
							sizes="(max-width: 896px) 100vw, 896px"
							class="w-full h-96 object-cover cursor-pointer gallery-image"
							loading={idx === 0 ? "eager" : "lazy"}
						/>
					</div>
				))}
			</div>

			<!-- Arrow Navigation -->
			<button id="arrow-left" aria-label="Previous image" class="absolute left-2 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white text-black rounded-full p-4 shadow-lg z-10">
				<i class="fas fa-chevron-left text-xl"></i>
			</button>
			<button id="arrow-right" aria-label="Next image" class="absolute right-2 top-1/2 -translate-y-1/2 bg-white/80 hover:bg-white text-black rounded-full p-4 shadow-lg z-10">
				<i class="fas fa-chevron-right text-xl"></i>
			</button>
		</div>

		<!-- Navigation Dots -->
		<div class="dots flex justify-center gap-2 mt-6"></div>

		<!-- View All Gallery Button -->
		<div class="flex justify-center mt-8">
			<button id="viewAllBtn" class="px-6 py-3 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition-colors">
				View All Photos
			</button>
		</div>
	</div>

	<!-- Thumbnail Grid Modal -->
	<div id="thumbnailModal" class="fixed inset-0 bg-black/95 hidden z-50 overflow-y-auto">
		<div class="container mx-auto px-4 py-8">
			<div class="flex justify-between items-center mb-6">
				<h3 class="text-2xl font-bold text-white">Gallery ({images.length} Photos)</h3>
				<button id="closeThumbnails" aria-label="Close gallery" class="text-white text-4xl hover:text-gray-300 p-2 min-w-12 min-h-12">&times;</button>
			</div>

			<div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
				{images.map((img, idx) => (
					<div class="thumbnail-item cursor-pointer overflow-hidden rounded-lg shadow-lg hover:shadow-2xl transition-shadow">
						<Image
							src={img}
							alt={`Gallery image ${idx + 1}`}
							width={400}
							height={300}
							class="w-full h-48 object-cover hover:scale-110 transition-transform"
							loading="lazy"
						/>
					</div>
				))}
			</div>
		</div>
	</div>

	<!-- Fullscreen Modal -->
	<div id="fullscreenModal" class="fixed inset-0 bg-black/95 flex items-center justify-center hidden z-50">
		<button id="closeFullscreen" aria-label="Close fullscreen image" class="absolute top-5 right-5 text-white text-4xl hover:text-gray-300 p-2 min-w-12 min-h-12">&times;</button>
		<img id="fullscreenImage" src="" alt="Gallery image fullscreen" class="max-w-full max-h-full rounded-lg" />
	</div>
</section>

<style>
	.dots {
		display: flex;
	}
	.dot {
		width: 44px;
		height: 44px;
		background: #cbd5e0;
		border-radius: 50%;
		cursor: pointer;
		transition: background 0.3s;
		border: 14px solid transparent;
		background-clip: content-box;
	}
	.dot.active {
		background: #3b82f6;
	}
</style>

<script>
	import KeenSlider from 'keen-slider';
	import 'keen-slider/keen-slider.min.css';

	document.addEventListener('DOMContentLoaded', () => {
		// Initialize slider
		const sliderElement = document.querySelector('.keen-slider');
		if (!sliderElement) return;

		const slider = new KeenSlider('.keen-slider', {
			loop: true,
			slides: {
				perView: 1,
				spacing: 10
			}
		});

		// Arrow navigation
		const arrowLeft = document.getElementById('arrow-left');
		const arrowRight = document.getElementById('arrow-right');

		arrowLeft?.addEventListener('click', () => slider.prev());
		arrowRight?.addEventListener('click', () => slider.next());

		// Navigation dots
		const dotsContainer = document.querySelector('.dots');
		const slides = document.querySelectorAll('.keen-slider__slide');

		slides.forEach((_, idx) => {
			const dot = document.createElement('button');
			dot.classList.add('dot');
			if (idx === 0) dot.classList.add('active');
			dot.addEventListener('click', () => slider.moveToIdx(idx));
			dotsContainer?.appendChild(dot);
		});

		slider.on('slideChanged', (s) => {
			const dots = document.querySelectorAll('.dot');
			dots.forEach((dot, idx) => {
				dot.classList.toggle('active', idx === s.track.details.rel);
			});
		});

		// Fullscreen modal
		const modal = document.getElementById('fullscreenModal');
		const fullscreenImg = document.getElementById('fullscreenImage') as HTMLImageElement;
		const closeBtn = document.getElementById('closeFullscreen');

		// Slider images → fullscreen
		document.querySelectorAll('.gallery-image').forEach((img) => {
			img.addEventListener('click', () => {
				if (fullscreenImg && modal) {
					fullscreenImg.src = (img as HTMLImageElement).src;
					modal.classList.remove('hidden');
				}
			});
		});

		closeBtn?.addEventListener('click', () => {
			modal?.classList.add('hidden');
		});

		modal?.addEventListener('click', (e) => {
			if (e.target === modal) {
				modal.classList.add('hidden');
			}
		});

		// Thumbnail grid modal
		const viewAllBtn = document.getElementById('viewAllBtn');
		const thumbnailModal = document.getElementById('thumbnailModal');
		const closeThumbnails = document.getElementById('closeThumbnails');

		viewAllBtn?.addEventListener('click', () => {
			thumbnailModal?.classList.remove('hidden');
		});

		closeThumbnails?.addEventListener('click', () => {
			thumbnailModal?.classList.add('hidden');
		});

		// Click thumbnail → fullscreen (read src from rendered img)
		document.querySelectorAll('.thumbnail-item').forEach((thumb) => {
			thumb.addEventListener('click', () => {
				const img = thumb.querySelector('img');
				if (fullscreenImg && modal && img) {
					fullscreenImg.src = img.src;
					thumbnailModal?.classList.add('hidden');
					modal.classList.remove('hidden');
				}
			});
		});

		// Close thumbnail modal on backdrop click
		thumbnailModal?.addEventListener('click', (e) => {
			if (e.target === thumbnailModal) {
				thumbnailModal.classList.add('hidden');
			}
		});
	});
</script>
